<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Color Generator - Wiisa</title>
<link rel="stylesheet" href="design.css">
<script src="config.js"></script>
</head>
<body>
<div class="app">
<header>
<h1>Color Generator - Intirely made with ChatGPT</h1>
<div class="controls">
<div class="small">Lang</div>
<select id="langSelect">
<option value="EN">EN</option>
<option value="DE">DE</option>
<option value="NL">NL</option>
</select>
<button id="clearAll">Clear All</button>
<button id="exportBtn">Export TXT</button>
<button id="importBtn">Import TXT</button>
<input id="importInput" type="file" accept=".txt" style="display:none" />
</div>
</header>

<div class="color-card">
<div id="swatch" class="swatch"></div>
<div class="meta">
<div class="hex" id="hexLabel">#FFFFFF</div>
<div class="name" id="nameLabel">Neutral Bright White</div>
<div class="stars-row">
<div style="flex:1"><div class="small">Rate how much you like it:</div><div id="stars1"></div></div>
<div style="flex:1"><div class="small">Optional: rate with a second person:</div><div id="stars2"></div></div>
</div>
<div style="margin-top:12px"><button id="nextBtn">Next Color</button></div>
</div>
</div>

<div id="tierArea" class="tier-wrap">
<strong>Live Tier List</strong>
<div id="tiersContainer" class="tiers"></div>
</div>
<footer>Haii Schatje ❤️</footer>
<div id="tooltip" class="tooltip"></div>

<script>
// ---------------- Variables ----------------
let currentColor = null;
let ratings = JSON.parse(localStorage.getItem("ratings") || "[]");
let currentLanguage = "EN";

const swatchEl = document.getElementById("swatch");
const hexLabelEl = document.getElementById("hexLabel");
const nameLabelEl = document.getElementById("nameLabel");
const stars1El = document.getElementById("stars1");
const stars2El = document.getElementById("stars2");
const nextBtn = document.getElementById("nextBtn");
const langSelect = document.getElementById("langSelect");
const tiersContainer = document.getElementById("tiersContainer");
const clearAllBtn = document.getElementById("clearAll");
const exportBtn = document.getElementById("exportBtn");
const importBtn = document.getElementById("importBtn");
const importInput = document.getElementById("importInput");
const tooltip = document.getElementById("tooltip");

let stars1 = [], stars2 = [], stars1Rating = 0, stars2Rating = 0;

// ---------------- Helpers ----------------
function randInt(min,max){return Math.floor(Math.random()*(max-min))+min;}
function generateHex(){return `#${randInt(0,256).toString(16).padStart(2,"0")}${randInt(0,256).toString(16).padStart(2,"0")}${randInt(0,256).toString(16).padStart(2,"0")}`;}

// ---------------- Color Naming ----------------
function hexToHSL(hex){
    let r=parseInt(hex.slice(1,3),16)/255;
    let g=parseInt(hex.slice(3,5),16)/255;
    let b=parseInt(hex.slice(5,7),16)/255;
    let max=Math.max(r,g,b), min=Math.min(r,g,b);
    let h,l,s; l=(max+min)/2;
    if(max===min){h=s=0;}else{
        let d=max-min;
        s=l>0.5?d/(2-max-min):d/(max+min);
        switch(max){case r:h=(g-b)/d+(g<b?6:0);break;case g:h=(b-r)/d+2;break;case b:h=(r-g)/d+4;break;}
        h/=6;
    }
    return [h,s,l];
}
function pickAdjective(value, table){for(let row of table){if(value>=row[0] && value<row[1]) return row[2][randInt(0,row[2].length)];}return "";}
function getBaseColor(hue){for(let row of baseColorMapEn){if(hue>=row[0] && hue<row[1]) return row[2];}return "Unknown";}
function getFancyColor(hue){for(let row of fancyColorMapEn){if(hue>=row[0] && hue<row[1]) return row[2];}return "Unknown";}
function generateColorName(hex){
    let [h,s,l]=hexToHSL(hex);
    let satAdj = pickAdjective(s,saturationAdjectives);
    let lightAdj = pickAdjective(l,lightnessAdjectives);
    let base = getBaseColor(h*360);
    let fancy = getFancyColor(h*360);
    return `${lightAdj} ${satAdj} ${fancy} ${base}`;
}

// ---------------- Stars ----------------
function createStars(container,idx){
    let arr=[];
    for(let i=0;i<10;i++){
        let s=document.createElement("span");
        s.className="star";
        s.textContent="☆";
        s.addEventListener("click",()=>{if(idx===1){stars1Rating=i+1}else{stars2Rating=i+1}updateStars();});
        container.appendChild(s); arr.push(s);
    }
    return arr;
}
function updateStars(){stars1.forEach((s,i)=>{s.textContent=i<stars1Rating?"★":"☆"});stars2.forEach((s,i)=>{s.textContent=i<stars2Rating?"★":"☆"});}

// ---------------- Tooltip ----------------
function showTooltip(content,x,y){tooltip.innerHTML=content;tooltip.style.top=(y+10)+"px";tooltip.style.left=(x+10)+"px";tooltip.style.opacity=1;}
function hideTooltip(){tooltip.style.opacity=0;}
document.addEventListener("mousemove", e=>{if(tooltip.style.opacity==1){tooltip.style.top=(e.clientY+10)+"px";tooltip.style.left=(e.clientX+10)+"px";}});

// ---------------- Translation ----------------
const translationCache={};
async function translateText(text,target){
    if(target==="EN") return text;
    let key=text+"_"+target;
    if(translationCache[key]) return translationCache[key];
    try{
        let res=await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=en&tl=${target}&dt=t&q=${encodeURIComponent(text)}`);
        let data=await res.json();
        let val=data[0][0][0]||text;
        translationCache[key]=val;
        return val;
    }catch(e){return text;}
}
async function translateColorName(name){return await translateText(name,currentLanguage);}

// ---------------- Color Generation ----------------
async function generateNext(){
    let hex = generateHex();
    let name = generateColorName(hex);
    return {hex,name_en:name};
}
async function showNextColor(){
    swatchEl.style.opacity=0.7; swatchEl.classList.add("loading");
    let newColor = await generateNext();
    currentColor = newColor;
    swatchEl.style.background=currentColor.hex;
    hexLabelEl.textContent=currentColor.hex;
    nameLabelEl.textContent = await translateColorName(currentColor.name_en);
    stars1El.innerHTML=""; stars2El.innerHTML="";
    stars1=createStars(stars1El,1);
    stars2=createStars(stars2El,2);
    stars1Rating=0; stars2Rating=0; updateStars();
    swatchEl.style.opacity=1; swatchEl.classList.remove("loading");
}

// ---------------- Tier Handling ----------------
function getTierFromRating(r){
    if(r>8) return "S";
    if(r>6) return "A";
    if(r>4) return "B";
    if(r>2) return "C";
    return "Trash";
}

function populateTiers(){
    tiersContainer.innerHTML="";
    let tierElems={};

    const tierMap = {S:9, A:7, B:5, C:3};

    ["S","A","B","C"].forEach(t=>{
        let div=document.createElement("div"); 
        div.className="tier";
        div.dataset.tier=t;
        let h=document.createElement("h3"); 
        h.textContent=t; 
        div.appendChild(h);
        tiersContainer.appendChild(div);
        tierElems[t]=div;

        div.addEventListener("dragover", e=>{e.preventDefault();});
        div.addEventListener("drop", e=>{
            e.preventDefault();
            let hex=e.dataTransfer.getData("text");
            let item=ratings.find(r=>r.hex===hex);
            if(!item) return;
            item.rating = tierMap[t];
            localStorage.setItem("ratings",JSON.stringify(ratings));
            populateTiers();
            hideTooltip();
        });
    });

    // Trash can
    let trash=document.createElement("div"); 
    trash.className="tier"; 
    let th=document.createElement("h3"); 
    th.textContent="Trash"; 
    trash.appendChild(th); 
    tiersContainer.appendChild(trash);

    trash.addEventListener("dragover", e=>e.preventDefault());
    trash.addEventListener("dragenter", ()=>trash.style.background="#b33");
    trash.addEventListener("dragleave", ()=>trash.style.background="var(--panel)");
    trash.addEventListener("drop", e=>{
        e.preventDefault(); 
        let hex=e.dataTransfer.getData("text");
        ratings = ratings.filter(r=>r.hex!==hex);
        localStorage.setItem("ratings",JSON.stringify(ratings));
        populateTiers(); 
        hideTooltip();
        trash.style.background="var(--panel)";
    });

    // Keep red color while hovering
    trash.addEventListener("dragover", ()=>trash.style.background="#b33");

    // Populate cards
    ratings.forEach(async r=>{
        let tier=getTierFromRating(r.rating);
        if(tier==="Trash") return;
        let div=document.createElement("div"); 
        div.className="card"; 
        div.textContent=r.hex; 
        div.style.background=r.hex; 
        div.setAttribute("draggable","true");

        // Drag start
        div.addEventListener("dragstart", e=>{e.dataTransfer.setData("text",r.hex);});

        // Touch support
        div.addEventListener("touchstart", e=>{e.target.dataset.touching = true;});
        div.addEventListener("touchend", e=>{
            let touchTarget = document.elementFromPoint(e.changedTouches[0].clientX, e.changedTouches[0].clientY);
            if(touchTarget.closest(".tier")){
                let t = touchTarget.closest(".tier").dataset.tier;
                if(t && tierMap[t]) r.rating = tierMap[t];
            }
            if(touchTarget.closest("h3") && touchTarget.closest(".tier").textContent==="Trash") {
                ratings = ratings.filter(x=>x.hex!==r.hex);
            }
            localStorage.setItem("ratings",JSON.stringify(ratings));
            populateTiers();
            delete e.target.dataset.touching;
        });

        div.addEventListener("mouseenter", async ()=>{
            let tname = await translateColorName(r.name_en);
            showTooltip(`<strong>${tname}</strong> Rating: ${r.rating}`, div.getBoundingClientRect().x, div.getBoundingClientRect().y);
        });
        div.addEventListener("mouseleave", hideTooltip);
        tierElems[tier].appendChild(div);
    });
}

// ---------------- Save & Next ----------------
nextBtn.addEventListener("click", ()=>saveAndNext());
document.addEventListener("keydown", e=>{if(e.code==="Enter"||e.code==="Space") saveAndNext();});
function saveAndNext(){
    let combinedRating = stars2Rating ? (stars1Rating+stars2Rating)/2 : stars1Rating;
    ratings.push({hex:currentColor.hex,name_en:currentColor.name_en,rating:combinedRating,stars1:stars1Rating,stars2:stars2Rating});
    localStorage.setItem("ratings",JSON.stringify(ratings));
    populateTiers(); showNextColor();
}

// ---------------- Export/Import ----------------
exportBtn.addEventListener("click", ()=>{
    let sorted = ratings.slice().sort((a,b)=>b.rating-a.rating || a.name_en.localeCompare(b.name_en));
    let data = sorted.map(r=>`${r.hex}, ${r.name_en}, (${r.rating})`).join("\n");
    let blob=new Blob([data],{type:"text/plain"});
    let a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="colors.txt"; a.click();
});
importBtn.addEventListener("click", ()=>importInput.click());
importInput.addEventListener("change", e=>{
    let reader=new FileReader();
    reader.onload=ev=>{
        try{
            let lines=ev.target.result.split("\n");
            ratings=lines.map(l=>{
                let parts=l.split(",");
                return {hex:parts[0].trim(), name_en:parts[1].trim(), rating:parseInt(parts[2].replace(/[()]/g,""))};
            });
            localStorage.setItem("ratings",JSON.stringify(ratings));
            populateTiers();
        }catch(err){alert("Invalid file");}
    };
    reader.readAsText(e.target.files[0]);
});

// ---------------- Language ----------------
langSelect.addEventListener("change", async ()=>{
    currentLanguage = langSelect.value;
    if(currentColor) nameLabelEl.textContent = await translateColorName(currentColor.name_en);
    populateTiers();
});

// ---------------- Clear ----------------
clearAllBtn.addEventListener("click", ()=>{
    ratings=[]; localStorage.removeItem("ratings"); populateTiers();
});

// ---------------- Init ----------------
showNextColor(); populateTiers();
</script>
</body>
</html>
